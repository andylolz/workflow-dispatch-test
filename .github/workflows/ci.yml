name: Deploy

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: I hereby accept full responsibility for any consequences arising from this workflow dispatch
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Check confirmation statement
        if: ${{ inputs.confirmation != true }}
        run: |
          echo 'You must accept full responsibility. Exiting'
          exit 1

      - name: Check we’re running on a tag, not a branch
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: |
          echo 'This workflow must be run on a tag! It won’t work otherwise'
          exit 1

      - name: Get environment from tag
        id: get-vars
        run: |
          tag=echo ${{ github.ref }} | cut -c 11-

          if [[ "$tag" =~ ^\d+\.\d+\.\d+$ ]]; then
              env=prod
          else
              env=dev
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "env=$env" >> "$GITHUB_OUTPUT"

      - name: Get release from tag
        id: get-release
        uses: actions/github-script@v7
        with:
          script: |
            return await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: ${{ steps.get-vars.outputs.tag }}
            });

      - run: |
          echo ${{ steps.get-vars.outputs.env }}
          echo ${{ steps.get-vars.outputs.tag }}
          echo ${{ toJson(fromJson(steps.get-release.outputs.result).data.body) }}
